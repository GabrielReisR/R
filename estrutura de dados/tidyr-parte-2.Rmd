---
title: 'Organizando com tidyr - Parte 2: valores missing'
author: "Gabriel R. R."
date: "8/2/2020"
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    smooth_scroll: true
    df_print: paged
    code_folding: show
---

# Considerações iniciais

**ESSA APRESENTAÇÃO ESTÁ EM CONSTRUÇÃO.**

Esse é um documento feito para ensinar e para reforçar conteúdos de manipulação de dados usando _tidyr_. Qualquer comentário, erro ou sugestão, é só falar comigo entrando em contato através de qualquer uma das opções listadas em *Contato*.

O script em R está disponível aqui: https://github.com/GabrielReisR/R/blob/master/estrutura%20de%20dados/tidyr-parte-1.R

Essa publicação possui uma continuação em *Organizando com tidyr - Parte 2: valores missing*: https://rpubs.com/reisrgabriel/tidyrPt2

## Organizando bancos - de wide data para long data
Às vezes, os dados estão desorganizados, o que pode dificultar as análises.

Um banco bem organizado é um no qual:

1. Cada célula é um valor único.
1. Cada coluna é uma variável.
1. Cada linha é uma observação.

Dados desorganizados, *untidy data*, quebram uma ou mais dessas regras acima.

## Sobre o _tidyr_

O _tidyr_ é um pacote criado pelo time do tidyverse com a função de organização de um banco de dados.

**Ele existe para que as três regras acima sejam cumpridas**.

Para maiores informações sobre o tidyr: 

* Documentação: https://cran.r-project.org/web/packages/tidyr/tidyr.pdf
* Página no tidyverse: https://tidyr.tidyverse.org/index.html
* Cheatsheet (folha de códigos): https://github.com/rstudio/cheatsheets/blob/master/data-import.pdf

## Banco a ser usado

Para explicar os conceitos sobre limpeza de missings, pegaremos os dados de bibliotecas públicas ao redor do mundo: https://github.com/GabrielReisR/R/tree/master/estrutura%20de%20dados/dados/libraries.csv

Antes de começar, vou fazer uma mudança  no nome com o pacote *dplyr*.

```{r Lendo libraries e renomeando id, message=FALSE, warning=FALSE}
biblios_original <- read.csv("https://raw.githubusercontent.com/GabrielReisR/R/master/estrutura%20de%20dados/dados/libraries.csv")

library(dplyr)
biblios_original <- biblios_original %>%
  rename(id = X)
```


# Limpando nomes das colunas
Vamos utilizar o pacote *janitor* para limpar o nome das colunas.

Vamos ver antes como estão as colunas:

```{r Vendo nomes das colunas}
names(biblios_original)
```

É preciso uniformizar os nomes para facilitar a manipulação do banco. Vamos ler e utilizar *janitor*, especificamente a função `clean_names()`.

```{r Usando janitor, message=FALSE, warning=FALSE}
library(janitor)

biblios_snake <- biblios_original %>% # note o uso do pipe
  clean_names() # se n?o dermos nenhum argumento, ent?o 'case = snake'

names(biblios_snake)

# lowerCamel
biblios_lowerCamel <- biblios_original %>% # note o uso do pipe
  clean_names(case = "lower_camel")

names(biblios_lowerCamel)

# UpperCamel
biblios_UpperCamel <- biblios_original %>% # note o uso do pipe
  clean_names(case = "upper_camel")

names(biblios_UpperCamel)

# screaming_snake
biblios_SCREAMING_SNAKE <- biblios_original %>% # note o uso do pipe
  clean_names(case = "screaming_snake")

names(biblios_SCREAMING_SNAKE)

# lowerUPPER
biblios_lowerUPPER <- biblios_original %>% # note o uso do pipe
  clean_names(case = "lower_upper")

names(biblios_lowerUPPER)

# UPPERlower
biblios_UPPERlower <- biblios_original %>% # note o uso do pipe
  clean_names(case = "upper_lower")

names(biblios_UPPERlower)


biblios <- biblios_snake # basta dar a biblios o valor de biblios_snake
names(biblios_snake)
```

# Limpando missings

Há diversas formas de lidar com missings.

```{r Limpando missings dataset com drop_na, message=FALSE, warning=FALSE}
library(Amelia) # para visualizar missings com 'missmap()'
library(tidyr)

biblios_zero_missing <- biblios %>% 
  drop_na() # nenhum argumento: qualquer linha que possua qualquer missing é excluída

missmap(biblios_zero_missing) # visualizando os missings
```

```{r Limpando missings variável com drop_na}
biblios_expenditures <- biblios %>% 
  drop_na(expenditures_us_dollars) # qualquer linha que possua missing nessa coluna é excluída

missmap(biblios_expenditures)
```

```{r Realocando variáveis}
biblios_exp <- biblios_expenditures %>% # renomeando o banco
  relocate(total_librarians, # colocando como primeira coluna
           total_users, # colocando como segunda coluna
           everything()) # restante das variáveis 

biblios_exp
```

* O id 68 e 82 possuem NAs em *total_librarians*.
* O id 77 posui NA em *total_users*.

```{r Preenche NAs com direction up}
# Preenche com o valor mais próximo
biblios_fill_up <- biblios_exp %>%
  fill(total_librarians,
       total_users,
       direction = "up") # pega o valor mais próximo de linhas de cima ('up')

biblios_fill_up
```

```{r Preenche NAs com direction up}
# Preenche com o valor mais próximo
biblios_fill_down <- biblios_exp %>%
  fill(total_librarians,
       total_users,
       direction = "down") # pega o valor mais próximo de linhas de cima ('up')

biblios_fill_down
```


```{r Trocando pela média ou outro número com replace_na}
mean(biblios_expenditures$total_librarians, na.rm = TRUE)
mean(biblios_expenditures$total_users, na.rm = TRUE)

biblios_replace <- biblios_exp %>% 
  replace_na(list(total_librarians = 5688.577, total_users = 9156959))

biblios_replace
```

```{r Trocando pela média usando base}
# Solução encontrada aqui: https://stackoverflow.com/questions/25835643/replace-missing-values-with-column-mean

sum(is.na(biblios_exp))

biblios_base <- for(i in 1:ncol(biblios_exp)){
  biblios_exp[is.na(biblios_exp[,i]), i] <- mean(biblios_exp[,i], na.rm = TRUE)
}

sum(is.na(biblios_base))

```

```{r Trocando pela média das colunas com o pacote zoo, message=FALSE, warning=FALSE}

library(zoo) # lendo o pacote. caso não tenha, instale: install.packages("zoo")

biblios_zoo <- na.aggregate(biblios_exp, by = 1, median) # escolhi mediana, e não média

missmap(biblios_zoo)

```
Por enquanto é isso! :)

---

# Mais informações
Organizando com tidyr - Parte 1: dados wide e long: https://rpubs.com/reisrgabriel/tidyrPt1

Manipulando com dplyr - Parte 1: select() e mutate(): https://rpubs.com/reisrgabriel/dplyrPt1

Manipulando com dplyr - Parte 2: bind() e join(): https://rpubs.com/reisrgabriel/dplyrPt2

Importação de dados e diagnósticos iniciais: https://rpubs.com/reisrgabriel/importdiagn

Para maiores informações sobre o tidyr: https://tidyr.tidyverse.org/ ou https://cran.r-project.org/web/packages/tidyr/tidyr.pdf

# Contato
Email: reisrgabriel@gmail.com

GitHub : https://github.com/GabrielReisR

LinkedIn: https://www.linkedin.com/in/gabrielreisrodrigues/